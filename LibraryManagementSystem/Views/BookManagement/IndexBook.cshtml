@* IndexBook.cshtml *@
@model IEnumerable<LibraryManagementSystem.ViewModels.BookViewModel>
@{
    ViewData["Title"] = "Book List";
}

<h2>Book List</h2>

<p>
    @if (User.IsInRole("Admin") || User.IsInRole("Librarian"))
    {
        <a asp-controller="BookManagement" asp-action="CreateBook" class="btn btn-primary">Create New Book</a>
    }
</p>

<table id="myTable" class="table table-bordered">
    <thead>
        <tr>
            <th>Book ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Author</th>
            <th>ISBN</th>
            <th>Publisher</th>
            <th>Published Date</th>
            <th>Category</th>
            <th>Cover Image</th>
            <th>Total Copies</th>
            <th>Borrow Records</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var book in Model)
        {
            <tr>
                <td>@book.BookId</td>
                <td>@book.Title</td>
                <td>@book.Description</td>
                <td>@book.Author</td>
                <td>@book.ISBN</td>
                <td>@book.Publisher</td>
                <td>@book.PublishedDate.ToShortDateString()</td>
                <td>@book.CategoryName</td>
                <td>
                    @if (!string.IsNullOrEmpty(book.CoverImage))
                    {
                        <img src="@book.CoverImage" alt="Cover Image" width="100" height="150" />
                    }
                    else
                    {
                        <span>No Image</span>
                    }
                </td>
                <td>@book.TotalCopies</td>
                <td>@book.BorrowRecords</td>
                <td>
                    <a asp-controller="BookManagement" asp-action="EditBook" asp-route-id="@book.BookId" class="btn btn-warning">Edit</a>
                    <button class="btn btn-danger btn-delete" data-id="@book.BookId">Delete</button>
                    @if (User.IsInRole("User"))
                    {
                        <button class="btn btn-success btn-borrow" data-id="@book.BookId">Borrow</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Delete book with SweetAlert and AJAX
            $('.btn-delete').click(function () {
                var bookId = $(this).data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/BookManagement/DeleteBook',
                            type: 'POST',
                            data: { id: bookId },
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire(
                                        'Deleted!',
                                        response.message,
                                        'success'
                                    ).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire(
                                        'Error!',
                                        response.message,
                                        'error'
                                    );
                                }
                            },
                            error: function () {
                                Swal.fire(
                                    'Error!',
                                    'Something went wrong.',
                                    'error'
                                );
                            }
                        });
                    }
                });
            });

            // Borrow book with SweetAlert and AJAX
        $('.btn-borrow').click(function () {
            var bookId = $(this).data('id');

            Swal.fire({
                title: 'Are you sure?',
                text: "Do you want to request this book for borrowing?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Request it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Borrow/ConfirmBorrow',
                        type: 'POST',
                        data: { bookId: bookId },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire(
                                    'Request Sent!',
                                    'Your borrow request has been submitted. Please wait for admin approval.',
                                    'success'
                                ).then(() => {
                                    location.reload(); // Refresh the page to reflect the request
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    response.message,
                                    'error'
                                );
                            }
                        },
                        error: function () {
                            Swal.fire(
                                'Error!',
                                'An error occurred while submitting your request.',
                                'error'
                            );
                        }
                    });
                }
            });
        });



            // Initialize DataTable
            $('#myTable').DataTable();
        });
    </script>
}
